import*as e from"rxjs";import*as r from"short-unique-id";import*as a from"memory-level";import*as o from"abstract-level";import*as d from"level";var n={d:(e,r)=>{for(var a in r)n.o(r,a)&&!n.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:r[a]})},o:(e,r)=>Object.prototype.hasOwnProperty.call(e,r)},t={};n.d(t,{eE:()=>I,tP:()=>v,FV:()=>f,qi:()=>b,_f:()=>j,qJ:()=>S,iC:()=>E,de:()=>g,mr:()=>y,g4:()=>c,SV:()=>u});const p=(l={Observable:()=>e.Observable,Subject:()=>e.Subject,catchError:()=>e.catchError,concatMap:()=>e.concatMap,filter:()=>e.filter,first:()=>e.first,from:()=>e.from,map:()=>e.map,merge:()=>e.merge,mergeMap:()=>e.mergeMap,of:()=>e.of,range:()=>e.range,switchMap:()=>e.switchMap,takeWhile:()=>e.takeWhile,tap:()=>e.tap,throwError:()=>e.throwError,toArray:()=>e.toArray},s={},n.d(s,l),s);var l,s;const i=(e=>{var r={};return n.d(r,e),r})({default:()=>r.default}),h=new i.default.default({dictionary:"alphanum"}),g=()=>h.stamp(12),u=e=>h.parseStamp(e),b=e=>{const r=new p.Subject,a=e.reduce(((e,r)=>e.pipe((0,p.mergeMap)(r))),r.asObservable());return a.next=e=>(setTimeout((()=>r.next(e))),a),a},c=()=>b([e=>(0,p.of)(e)]),m={LABEL:"0",FROM_REL:"1",TO_REL:"2",PROP:"3"},v=e=>{var r,a,o,d,n,t,l;return(0,p.of)(Object.assign(Object.assign({},e),{handlers:{putNode:(null===(r=e.handlers)||void 0===r?void 0:r.putNode)||c(),getNode:(null===(a=e.handlers)||void 0===a?void 0:a.getNode)||c(),putEdge:(null===(o=e.handlers)||void 0===o?void 0:o.putEdge)||c(),getEdge:(null===(d=e.handlers)||void 0===d?void 0:d.getEdge)||c(),nodesByLabel:(null===(n=e.handlers)||void 0===n?void 0:n.nodesByLabel)||c(),nodesByProp:(null===(t=e.handlers)||void 0===t?void 0:t.nodesByProp)||c(),getRelationships:(null===(l=e.handlers)||void 0===l?void 0:l.getRelationships)||c()}}))},f=(e,r,a,o)=>(0,p.of)({nodeId:r||g(),label:a,props:o}).pipe((0,p.switchMap)((r=>e.handlers.putNode.next({graph:e,node:r}).pipe((0,p.filter)((({node:{nodeId:e}})=>r.nodeId===e))))),(0,p.map)((({node:r})=>({graph:e,nodeId:r.nodeId}))),(0,p.first)()),I=(e,r)=>new p.Observable((a=>{const o=e.handlers.putNode.pipe((0,p.tap)((()=>e.handlers.getNode.next({graph:e,nodeId:r})))).subscribe(),d=e.handlers.getNode.next({graph:e,nodeId:r}).pipe((0,p.filter)((({node:e,nodeId:r})=>void 0===e||e.nodeId===r)),(0,p.map)((({node:e})=>({node:e}))),(0,p.tap)((({node:o})=>a.next({graph:e,nodeId:r,node:o})))).subscribe();return()=>{o.unsubscribe(),d.unsubscribe()}})),y=(e,r)=>new p.Observable((a=>{const o=e.handlers.putNode.pipe((0,p.tap)((()=>e.handlers.nodesByLabel.next({graph:e,label:r})))).subscribe(),d=e.handlers.nodesByLabel.next({graph:e,label:r}).pipe((0,p.filter)((({label:e})=>e===r)),(0,p.map)((({nodes:a})=>({graph:e,label:r,nodes:a}))),(0,p.tap)((({nodes:o})=>a.next({graph:e,nodes:o,label:r})))).subscribe();return()=>{o.unsubscribe(),d.unsubscribe()}})),w=(e=>{var r={};return n.d(r,e),r})({MemoryLevel:()=>a.MemoryLevel});n.d({},{});const L=(e=>{var r={};return n.d(r,e),r})({Level:()=>d.Level}),M={},O=(e,r)=>(0,p.of)(M[e.graphId]).pipe((0,p.map)((e=>e||(r.dir?new L.Level(r.dir):new w.MemoryLevel))),(0,p.tap)((r=>M[e.graphId]=r))),j=e=>({graph:r,nodeId:a})=>O(r,e).pipe((0,p.mergeMap)((e=>e.get([r.graphId,a].join(".")))),(0,p.map)((e=>({graph:r,node:JSON.parse(e),nodeId:a}))),(0,p.catchError)((e=>e.notFound?(0,p.of)({graph:r,nodeId:a}):(0,p.throwError)(e)))),E=e=>({graph:r,node:a})=>O(r,e).pipe((0,p.switchMap)((e=>(0,p.merge)(e.put([r.graphId,a.nodeId].join("."),JSON.stringify(a)),e.put([r.graphId,m.LABEL,a.label,a.nodeId].join("."),""),N(r,e,a)))),(0,p.map)((()=>({graph:r,node:a})))),N=(e,r,a)=>(0,p.from)(Object.keys(a.props)).pipe((0,p.switchMap)((o=>r.put([e.graphId,m.PROP,a.label,o,a.props[o].toString(),a.nodeId].join("."),"")))),S=e=>({graph:r,label:a})=>O(r,e).pipe((0,p.switchMap)((e=>((e,r)=>new p.Observable((a=>{const o=e.iterator(r);return a.next(o),()=>o.close()})))(e,x([r.graphId,m.LABEL,a])))),(0,p.switchMap)((a=>(0,p.range)(1,1e3).pipe((0,p.concatMap)((()=>a.next())),(0,p.takeWhile)((e=>!!(null==e?void 0:e[0]))),(0,p.map)((e=>null==e?void 0:e[0].split(".")[3])),(0,p.switchMap)((a=>j(e)({graph:r,nodeId:a}))),(0,p.map)((({node:e})=>e)),(0,p.toArray)()))),(0,p.map)((e=>({graph:r,label:a,nodes:e})))),x=e=>e[e.length-1].includes("*")?{gte:e.join(".").replace("*",""),lt:e.join(".").replace("*","")+String.fromCharCode(255)}:{gt:e.join(".")+".",lt:e.join(".")+"."+String.fromCharCode(255)};var P=t.eE,B=t.tP,R=t.FV,A=t.qi,C=t._f,q=t.qJ,F=t.iC,k=t.de,H=t.mr,J=t.g4,V=t.SV;export{P as graphGet,B as graphOpen,R as graphPut,A as handlers,C as levelStoreGetNodeHandler,q as levelStoreNodesByLabelHandler,F as levelStorePutNodeHandler,k as newUid,H as nodesByLabel,J as nullHandler,V as timestampFromUid};